model User {
  id            String  @id
  name          String
  email         String
  emailVerified Boolean @default(false)
  image         String?
  role          String  @default("user") // "super_admin" for platform admin, "user" for regular users

  // Personal subscription (B2C)
  personalSubscription PersonalSubscription?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  sessions    Session[]
  accounts    Account[]
  departments Department[] @relation("DepartmentUsers")

  // Organization relations (B2B)
  memberships          OrganizationMember[]
  createdOrganizations Organization[]       @relation("OrganizationCreator")
  sentInvites          OrganizationInvite[]

  // PhishGuard relations
  scans          Scan[]
  emailScans     EmailScan[]
  dashboardStats DashboardStats?
  apiTokens      ApiToken[]
  userActions    UserAction[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// Organizations
model Organization {
  id     String  @id @default(cuid())
  name   String
  slug   String  @unique
  domain String? @unique
  logo   String?

  subscription Subscription?
  members      OrganizationMember[]
  invites      OrganizationInvite[]
  apiTokens    ApiToken[]
  scans        Scan[]

  settings Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("OrganizationCreator", fields: [createdById], references: [id])

  @@index([slug])
  @@index([domain])
  @@map("organization")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String // "admin", "member", "viewer"
  joinedAt       DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_member")
}

model OrganizationInvite {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String       @default("member")
  token          String       @unique
  invitedById    String
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@map("organization_invite")
}

// Personal Subscription (B2C - Individual Users)
model PersonalSubscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan   String @default("free") // "free", "personal_plus", "personal_pro"
  status String @default("active")

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Personal limits
  scansPerMonth Int @default(100)
  scansPerHour  Int @default(25)
  maxApiTokens  Int @default(1)

  features Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@map("personal_subscription")
}

// Organization Subscription (B2B - Teams/Companies)
model Subscription {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  plan   String @default("free") // "team_free", "team_startup", "team_business", "team_enterprise"
  status String @default("active")

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Team limits
  maxMembers          Int @default(3)
  scansPerMonth       Int @default(500)
  scansPerHourPerUser Int @default(25)
  maxApiTokens        Int @default(1)

  features Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([stripeCustomerId])
  @@map("subscription")
}

// API Tokens (User or Organization)
model ApiToken {
  id    String @id @default(cuid())
  token String @unique
  name  String @default("API Token")

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdById  String
  expiresAt    DateTime?
  lastUsedAt   DateTime?
  requestCount Int       @default(0)
  hourlyLimit  Int       @default(100)
  isActive     Boolean   @default(true)
  lastResetAt  DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([token])
  @@map("api_token")
}
